package com.FlightBooking.controller;

import com.FlightBooking.dto.request.FlightRequest;
import com.FlightBooking.dto.request.FlightSearchRequest;
import com.FlightBooking.dto.response.FlightResponse;
import com.FlightBooking.dto.response.FlightSearchResultResponse;
import com.FlightBooking.service.AirlineService;
import com.FlightBooking.service.BookingService;
import com.FlightBooking.service.FlightService;
import com.FlightBooking.exception.GlobalExceptionHandler;
import com.FlightBooking.enums.Cities; // adjust if package differs
import com.FlightBooking.enums.TripType; // adjust if package differs
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.Mock;
import org.mockito.Mockito;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.http.MediaType;
import org.springframework.test.web.reactive.server.WebTestClient;
import reactor.core.publisher.Mono;

import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.List;

@ExtendWith(MockitoExtension.class)
class FlightControllerTest {

    private WebTestClient webTestClient;

    @Mock private FlightService flightService;
    @Mock private AirlineService airlineService;
    @Mock private BookingService bookingService;

    @BeforeEach
    void setup() {
        FlightBookingController controller = new FlightBookingController(airlineService, flightService, bookingService);
        this.webTestClient = WebTestClient.bindToController(controller)
                .controllerAdvice(new GlobalExceptionHandler())
                .build();
    }

    @Test
    void addFlight_returns201WithIdAndCode() {
        FlightRequest req = new FlightRequest();
        req.setAirlineId("AIRLINE_ID");
        req.setFlightCode("AI201");
        req.setAirlineCode("AI");
        req.setAirlineName("AirIndia");
        req.setFromCity(Cities.DELHI);
        req.setToCity(Cities.MUMBAI);
        req.setDepartureTime(LocalDateTime.of(2025,12,1,10,0));
        req.setPrice(4500f);
        req.setTotalSeats(120);

        FlightResponse resp = new FlightResponse();
        resp.setId("F1");
        resp.setFlightCode("AI201");

        Mockito.when(flightService.addFlightToInventory(Mockito.any(FlightRequest.class)))
               .thenReturn(Mono.just(resp));

        webTestClient.post()
                .uri("/api/v1.0/flight/airline/inventory")
                .contentType(MediaType.APPLICATION_JSON)
                .bodyValue(req)
                .exchange()
                .expectStatus().isCreated()
                .expectBody()
                .jsonPath("$.id").isEqualTo("F1")
                .jsonPath("$.flightCode").isEqualTo("AI201");
    }

    @Test
    void searchFlight_roundTrip_returnsOnwardAndReturn() {
        FlightSearchRequest req = new FlightSearchRequest();
        req.setFromCity(Cities.DELHI);
        req.setToCity(Cities.MUMBAI);
        req.setJourneyDate(LocalDate.of(2025,12,1));
        req.setTripType(TripType.ROUND_TRIP);
        req.setReturnDate(LocalDate.of(2025,12,5));

        FlightResponse o = new FlightResponse(); o.setId("ON1"); o.setFlightCode("AI201");
        FlightResponse r = new FlightResponse(); r.setId("RT1"); r.setFlightCode("AI202");

        FlightSearchResultResponse serviceResp = new FlightSearchResultResponse();
        serviceResp.setTripType(TripType.ROUND_TRIP);
        serviceResp.setOnwardFlights(List.of(o));
        serviceResp.setReturnFlights(List.of(r));

        Mockito.when(flightService.searchFlights(Mockito.any(FlightSearchRequest.class)))
               .thenReturn(Mono.just(serviceResp));

        webTestClient.post()
                .uri("/api/v1.0/flight/search")
                .contentType(MediaType.APPLICATION_JSON)
                .bodyValue(req)
                .exchange()
                .expectStatus().isOk()
                .expectBody()
                .jsonPath("$.tripType").isEqualTo("ROUND_TRIP")
                .jsonPath("$.onwardFlights[0].flightCode").isEqualTo("AI201")
                .jsonPath("$.returnFlights[0].flightCode").isEqualTo("AI202");
    }
}